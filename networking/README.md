# Networking

eBPF 프로그램은 네트워크 스택의 다양한 지점을 통과하는 네트워크 메시지를 처리하기 위해 다양한 유형으로 사용된다.
- 이러한 프로그램은 일반적으로 네트워크 스택의 다양한 위치에 연결되어 동작한다.
- 프로그램을 사용하려면 `CAP_NET_ADMIN`, `CAP_BPF`, `CAP_SYS_ADMIN` 권한이 필요하다.


### 네트워크 스택 구조 (다양한 BPF 프로그램 종류)
네트워크 스택이란 네트워크 통신을 처리하는 소프트웨어 계층의 집합을 의미한다.
![network stack.png](img%2Fnetwork%20stack.png)


- eBPF 프로그램에서 반환 코드를 사용하여 커널에게 네트워크 패킷을 처리하는 방법을 알려준다.
  - 일반적인 처리, 패킷 삭제, 다른 대상으로 패킷을 리다이렉션하는 등의 동작을 수행할 수 있다.
- eBPF 프로그램이 네트워크 패킷, 소켓 설정 매개변수 등을 수정할 수 있다.

---

## eBPF 네트워크 프로그램 유형 

### Sockets
네트워크 스택의 맨 위에는 소켓과 소켓 작업과 관련된 일부 네트워크 프로그램 유형이 있다.

- `BPF_PROG_TYPE_SOCKET_FILTER` : 소켓 필터링에 사용된다.
  - 응용 프로그램으로부터 전송되는 데이터를 필터링 하는 것이 아니라 tcpdump 와 같은 관측 도구로 전송될 소켓 데이터의 사본을 필터링 하는데에 사용
- 소켓은 L4 TCP 연결에 특정된다.
  - `BPF_PROG_TYPE_SOCK_OPS` : 소켓에서 발생하는 다양한 작업과 동작을 가로채고, 해당 소켓에 대해 TCP 타임아웃 값과 같은 매개변수를 설정할 수 있는 기능을 제공
  - 소켓은 연결의 엔드포인트에만 존재하며 이를 통과하는 중간 상자에는 존재하지 않는다.
- `BPF_PROG_TYPE_SK_SKB` : 이 프로그램은 소켓에 대한 reference 모음을 보유하는 특수한 맵 유형과 함께 사용되어 소켓 레벨에서 트래픽을 다른 대상으로 리다이렉션 하는 소켓 맵 작업을 제공

### Traffic Control (TC)
- eBPF 를 사용하여 TC를 구현하면 네트워크 트래픽을 제어하고 관리할 수 있다.
- TC는 리눅스 커널에서 제공하는 기능으로, 네트워크 인터페이스에서 들어오고 나가는 트래픽을 제어 및 조작하는 데 사용된다.
- Cilium 및 기타 컨테이너 네트워킹 솔루션에서 널리 사용되고 있다.


### XDP(eXpress Data Path)
(작성 예정)

### Flow Dissector
(작성 예정)



### Lightweight Tunnels
(작성 예정)


### Cgroups(제어 그룹)
- Linux 커널에서 프로세스 또는 일부 프로세스 그룹이 액세스할 수 있는 리소스 집합을 제한하는 개념
- 컨테이너나 Kubernetes Pod 과 같은 것들을 서로 분리하는 매커니즘 중 하나
- eBPF 프로그램을 cgroup에 연결하면 해당 cgroup의 프로세스에만 적용되는 사용자 정의 동작을 수행할 수 있다.
- 모든 프로세스는 cgroup 과 연관되어 있으며 컨테이너 내에서 실행되지 않는 프로세스도 cgroup 에 속한다.